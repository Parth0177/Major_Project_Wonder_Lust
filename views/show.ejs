<% layout('/layouts/boilerplate') %>
<body>
  <div class="show-container">
    <!-- Listing Image with Lightbox -->
    <div class="listing-image">
      <img
        src="<%= listing.image.url %>"
        alt="Listing Image"
        class="blur-up"
        loading="lazy"
        onclick="openLightbox(this.src)"
      />
    </div>

    <!-- Listing Info -->
    <i>Posted By: <%= listing.owner.username %></i>
    <h3><%= listing.title %></h3>
    <ul>
      <li>Description: <%= listing.description %></li>
      <li>Price: ₹ <%= listing.price.toLocaleString('en-IN') %></li>
      <li>Location: <%= listing.location %></li>
      <li>Country: <%= listing.country %></li>
    </ul>

    <!-- Action Buttons -->
    <% if(currentUser && currentUser._id.equals(listing.owner._id)) { %>
      <a href="/listings/<%= listing._id %>/edit" class="btn edit-btn">Edit Listing</a>
      <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="display:inline;">
        <button class="btn delete-btn">Delete Listing</button>
      </form>
    <% } %>
  </div>

  <!-- Review Form -->
  <div class="col-8 offset-3">
    <% if (currentUser) { %>
      <p>Leave a Review:</p>
      <form action="/listings/<%= listing._id %>/reviews" method="POST">
        <fieldset class="starability-slot">
          <legend>Rating</legend>

          <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="0" checked aria-label="No rating." />

          <input type="radio" id="rate1" name="review[rating]" value="1" />
          <label for="rate1" title="Terrible">★</label>

          <input type="radio" id="rate2" name="review[rating]" value="2" />
          <label for="rate2" title="Not good">★</label>

          <input type="radio" id="rate3" name="review[rating]" value="3" />
          <label for="rate3" title="Average">★</label>

          <input type="radio" id="rate4" name="review[rating]" value="4" />
          <label for="rate4" title="Very good">★</label>

          <input type="radio" id="rate5" name="review[rating]" value="5" />
          <label for="rate5" title="Amazing">★</label>
        </fieldset>

        <div>
          <label for="comment">Comment</label>
          <textarea id="comment" name="review[comment]" rows="4" cols="50" required></textarea>
        </div>

        <button>Submit</button>
      </form>
      <br>
    <% } %>
  </div>

  <!-- All Reviews Section -->
  <div class="col-8 offset-3">
    <h4>All Reviews</h4>
    <% for (review of listing.reviews) { %>
      <div class="review-card">
        <h5><%= review.author.username %></h5>
        <div class="stars">Rating:
          <% for (let i = 1; i <= 5; i++) { %>
            <% if (i <= review.rating) { %>
              <span>★</span>
            <% } else { %>
              <span style="color: #ccc;">★</span>
            <% } %>
          <% } %>
        </div>
        <p><strong>Comment:</strong> <%= review.comment %></p>

        <% if (currentUser && review.author._id.equals(currentUser._id)) { %>
          <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
            <button class="btn btn-sm btn-dark">Delete Review</button>
          </form>
        <% } %>
      </div>
      <hr>
    <% } %>
  </div>
</body>
